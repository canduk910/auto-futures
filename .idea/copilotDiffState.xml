<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/auto-futures/.dockerignore">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/auto-futures/.dockerignore" />
              <option name="updatedContent" value="# Git&#10;.git&#10;.gitignore&#10;&#10;# Python cache&#10;__pycache__/&#10;*.pyc&#10;*.pyo&#10;*.pyd&#10;.Python&#10;&#10;# Virtualenv&#10;.venv/&#10;venv/&#10;&#10;# Local runtime / secrets&#10;.env&#10;runtime/&#10;logs/&#10;&#10;# IDE / editor&#10;.idea/&#10;.vscode/&#10;.DS_Store&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/auto-futures/.env">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/auto-futures/.env" />
              <option name="originalContent" value="# Binance API keys (fill in the values from your account)&#10;BINANCE_TESTNET_API_KEY=i1kZvLLZy0a9uHMoa3yR36xnpRS8S1srEGj0Wkl16NVSbZ8Uv84WizfdDzhQIiGY&#10;BINANCE_TESTNET_SECRET_KEY=4e7sJQkzEyHa8OP0yI7ppVFIXFerfYKakpE7S0WNvtMWj1KGLezlD2UERItVjO3B&#10;BINANCE_API_KEY=&#10;BINANCE_SECRET_KEY=&#10;&#10;# OPEN AI API Key&#10;OPENAI_API_KEY=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&#10;LOG_LEVEL=INFO&#10;&#10;# Default environment (&quot;paper&quot; for testnet, &quot;live&quot; for real trading)&#10;ENV=paper&#10;DRY_RUN=False   # 주문실행 테스트용 플래그 (True: 주문 실행 안함, False: 실제 주문 실행)&#10;SYMBOL=ETHUSDT  # 거래 심볼 (예: BTCUSDT, ETHUSDT 등)&#10;LEVERAGE=5      # 레버리지 설정 (예: 1, 5, 10, 20 등)&#10;POSITION_SIDE=LONG  # 포지션 방향 (LONG&#10;&#10;# 웹소켓 설정 (WebSocket settings)&#10;WS_ENABLE=true          # 웹소켓 사용 여부&#10;WS_USER_ENABLE=true     # 사용자 데이터 스트림 사용 여부&#10;WS_PRICE_ENABLE=true    # 가격 데이터 스트림 사용 여부&#10;WS_TRACE=true           # 웹소켓 디버그 트레이스 출력 여부&#10;&#10;# Loop/runner options&#10;LOOP_ENABLE=true&#10;LOOP_TRIGGER=event        # kline | timer | event&#10;LOOP_INTERVAL_SEC=60&#10;LOOP_COOLDOWN_SEC=8&#10;LOOP_BACKOFF_MAX_SEC=30&#10;&#10;# Volatility detector parameters&#10;MP_WINDOW_SEC=10&#10;MP_DELTA_PCT=0.35&#10;KLINE_RANGE_PCT=0.6&#10;VOL_LOOKBACK=20&#10;VOL_MULT=3.0&#10;USE_QUOTE_VOLUME=true&#10;" />
              <option name="updatedContent" value="# Binance API keys (fill in the values from your account)&#10;BINANCE_TESTNET_API_KEY=i1kZvLLZy0a9uHMoa3yR36xnpRS8S1srEGj0Wkl16NVSbZ8Uv84WizfdDzhQIiGY&#10;BINANCE_TESTNET_SECRET_KEY=4e7sJQkzEyHa8OP0yI7ppVFIXFerfYKakpE7S0WNvtMWj1KGLezlD2UERItVjO3B&#10;BINANCE_API_KEY=&#10;BINANCE_SECRET_KEY=&#10;&#10;# OPEN AI API Key&#10;OPENAI_API_KEY=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&#10;LOG_LEVEL=INFO&#10;&#10;# Default environment (&quot;paper&quot; for testnet, &quot;live&quot; for real trading)&#10;ENV=paper&#10;DRY_RUN=False   # 주문실행 테스트용 플래그 (True: 주문 실행 안함, False: 실제 주문 실행)&#10;SYMBOL=ETHUSDT  # 거래 심볼 (예: BTCUSDT, ETHUSDT 등)&#10;LEVERAGE=5      # 레버리지 설정 (예: 1, 5, 10, 20 등)&#10;POSITION_SIDE=LONG  # 포지션 방향 (LONG&#10;&#10;# 웹소켓 설정 (WebSocket settings)&#10;WS_ENABLE=true          # 웹소켓 사용 여부&#10;WS_USER_ENABLE=true     # 사용자 데이터 스트림 사용 여부&#10;WS_PRICE_ENABLE=true    # 가격 데이터 스트림 사용 여부&#10;WS_TRACE=true           # 웹소켓 디버그 트레이스 출력 여부&#10;&#10;# Loop/runner options&#10;LOOP_ENABLE=true&#10;LOOP_TRIGGER=event        # kline | timer | event&#10;LOOP_INTERVAL_SEC=60&#10;LOOP_COOLDOWN_SEC=8&#10;LOOP_BACKOFF_MAX_SEC=30&#10;&#10;# Volatility detector parameters&#10;MP_WINDOW_SEC=10&#10;MP_DELTA_PCT=0.35&#10;KLINE_RANGE_PCT=0.6&#10;VOL_LOOKBACK=20&#10;VOL_MULT=3.0&#10;USE_QUOTE_VOLUME=true" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/cloud_run_deploy.sh">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/cloud_run_deploy.sh" />
              <option name="originalContent" value="#!/usr/bin/env bash&#10;# Helper to build &amp; deploy auto-futures to Cloud Run with env/secrets.&#10;set -euo pipefail&#10;&#10;REPO_ROOT=$(cd &quot;$(dirname &quot;$0&quot;)/..&quot; &amp;&amp; pwd)&#10;cd &quot;$REPO_ROOT&quot;&#10;&#10;ENV_FILE=${ENV_FILE:-.env}&#10;LOAD_ENV_FILE=${LOAD_ENV_FILE:-true}&#10;if [[ &quot;$LOAD_ENV_FILE&quot; == &quot;true&quot; &amp;&amp; -f &quot;$ENV_FILE&quot; ]]; then&#10;  echo &quot;[STEP] Loading environment variables from $ENV_FILE&quot;&#10;  set -a&#10;  # shellcheck disable=SC1090&#10;  source &quot;$ENV_FILE&quot;&#10;  set +a&#10;fi&#10;&#10;PROJECT_ID=${PROJECT_ID:?&quot;set PROJECT_ID environment variable (e.g., PROJECT_ID=my-project)&quot;}&#10;REGION=${REGION:-asia-northeast3}&#10;SERVICE=${SERVICE:-auto-futures}&#10;IMAGE_NAME=${IMAGE_NAME:-auto-futures}&#10;IMAGE=${IMAGE:-&quot;asia-northeast3-docker.pkg.dev/${PROJECT_ID}/auto-futures/${IMAGE_NAME}&quot;}&#10;BUILD_CONFIG=${BUILD_CONFIG:-cloudbuild.yaml}&#10;MEMORY=${MEMORY:-1Gi}&#10;CPU=${CPU:-1}&#10;MAX_INSTANCES=${MAX_INSTANCES:-1}&#10;ALLOW_UNAUTH=${ALLOW_UNAUTH:-true}&#10;BUILD_LOGGING=${BUILD_LOGGING:-cloud-logging-only}&#10;GRANT_SECRET_ROLES=${GRANT_SECRET_ROLES:-true}&#10;SECRET_ROLE=${SECRET_ROLE:-roles/secretmanager.admin}&#10;SUPPORTS_BUILD_LOGGING_FLAG=&quot;&quot;&#10;SYNC_RUNTIME=${SYNC_RUNTIME:-false}&#10;SYNC_MODE=${SYNC_MODE:-upload}&#10;GCS_BUCKET=${GCS_BUCKET:-}&#10;GCS_PREFIX=${GCS_PREFIX:-runtime/}&#10;&#10;add_env_var() {&#10;  local key=&quot;$1&quot;&#10;  local value=&quot;$2&quot;&#10;  for i in &quot;${!env_vars[@]}&quot;; do&#10;    if [[ &quot;${env_vars[$i]%%=*}&quot; == &quot;$key&quot; ]]; then&#10;      env_vars[$i]=&quot;$key=$value&quot;&#10;      return&#10;    fi&#10;  done&#10;  env_vars+=(&quot;$key=$value&quot;)&#10;}&#10;&#10;ensure_secret() {&#10;  local secret=&quot;$1&quot;&#10;  if ! gcloud secrets describe &quot;$secret&quot; &gt;/dev/null 2&gt;&amp;1; then&#10;    echo &quot;[WARN] Secret $secret not found. Create it before deployment.&quot; &gt;&amp;2&#10;  fi&#10;}&#10;&#10;detect_build_logging_support() {&#10;  [[ -n &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; ]] &amp;&amp; return 0&#10;  if gcloud builds submit --help 2&gt;/dev/null | grep -q &quot;--logging&quot;; then&#10;    SUPPORTS_BUILD_LOGGING_FLAG=&quot;yes&quot;&#10;  else&#10;    SUPPORTS_BUILD_LOGGING_FLAG=&quot;no&quot;&#10;  fi&#10;}&#10;&#10;maybe_grant_secret_roles() {&#10;  [[ &quot;$GRANT_SECRET_ROLES&quot; == &quot;true&quot; ]] || return 0&#10;  local project_number&#10;  project_number=$(gcloud projects describe &quot;$PROJECT_ID&quot; --format='value(projectNumber)')&#10;  local build_sa=&quot;${project_number}@cloudbuild.gserviceaccount.com&quot;&#10;  local run_sa=&quot;${project_number}-compute@developer.gserviceaccount.com&quot;&#10;  echo &quot;[STEP] Ensuring Secret Manager role $SECRET_ROLE for $build_sa and $run_sa&quot;&#10;  gcloud projects add-iam-policy-binding &quot;$PROJECT_ID&quot; \&#10;    --member=&quot;serviceAccount:${build_sa}&quot; \&#10;    --role=&quot;$SECRET_ROLE&quot; &gt;/dev/null&#10;  gcloud projects add-iam-policy-binding &quot;$PROJECT_ID&quot; \&#10;    --member=&quot;serviceAccount:${run_sa}&quot; \&#10;    --role=&quot;$SECRET_ROLE&quot; &gt;/dev/null&#10;}&#10;&#10;sync_runtime() {&#10;  [[ &quot;$SYNC_RUNTIME&quot; == &quot;true&quot; ]] || return 0&#10;  if [[ -z &quot;$GCS_BUCKET&quot; ]]; then&#10;    echo &quot;[WARN] SYNC_RUNTIME=true지만 GCS_BUCKET이 설정되지 않았습니다. runtime 동기화를 건너뜁니다.&quot; &gt;&amp;2&#10;    return 0&#10;  fi&#10;  if ! command -v python3 &gt;/dev/null 2&gt;&amp;1; then&#10;    echo &quot;[WARN] python3를 찾을 수 없어 runtime 동기화를 건너뜁니다.&quot; &gt;&amp;2&#10;    return 0&#10;  fi&#10;  echo &quot;[STEP] Running runtime sync (${SYNC_MODE}) with bucket ${GCS_BUCKET}&quot;&#10;  if [[ &quot;$SYNC_MODE&quot; == &quot;upload&quot; ]]; then&#10;    python3 scripts/gcs_sync.py --bucket &quot;$GCS_BUCKET&quot; &quot;$SYNC_MODE&quot; --dest-prefix &quot;$GCS_PREFIX&quot; || echo &quot;[WARN] runtime 동기화 실패 (무시하고 계속 진행)&quot; &gt;&amp;2&#10;  else&#10;    python3 scripts/gcs_sync.py --bucket &quot;$GCS_BUCKET&quot; &quot;$SYNC_MODE&quot; --prefix &quot;$GCS_PREFIX&quot; || echo &quot;[WARN] runtime 동기화 실패 (무시하고 계속 진행)&quot; &gt;&amp;2&#10;  fi&#10;}&#10;&#10;main() {&#10;  gcloud config set project &quot;$PROJECT_ID&quot; &gt;/dev/null&#10;&#10;  sync_runtime&#10;&#10;  maybe_grant_secret_roles&#10;&#10;  echo &quot;[STEP] Building container image ${IMAGE}&quot;&#10;  detect_build_logging_support&#10;  if [[ -f &quot;$BUILD_CONFIG&quot; ]]; then&#10;    if [[ &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; == &quot;yes&quot; ]]; then&#10;      gcloud builds submit --config &quot;$BUILD_CONFIG&quot; --substitutions=_IMAGE=&quot;$IMAGE&quot; --logging=&quot;$BUILD_LOGGING&quot;&#10;    else&#10;      echo &quot;[INFO] gcloud builds submit --logging not supported on this version; using default logging behavior&quot;&#10;      gcloud builds submit --config &quot;$BUILD_CONFIG&quot; --substitutions=_IMAGE=&quot;$IMAGE&quot;&#10;    fi&#10;  else&#10;    if [[ &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; == &quot;yes&quot; ]]; then&#10;      gcloud builds submit --tag &quot;$IMAGE&quot; --logging=&quot;$BUILD_LOGGING&quot;&#10;    else&#10;      echo &quot;[INFO] gcloud builds submit --logging not supported on this version; using default logging behavior&quot;&#10;      gcloud builds submit --tag &quot;$IMAGE&quot;&#10;    fi&#10;  fi&#10;&#10;  ensure_secret binance-testnet-api-key&#10;  ensure_secret binance-testnet-secret-key&#10;  ensure_secret openai-api-key&#10;&#10;  echo &quot;[STEP] Deploying ${SERVICE} to Cloud Run&quot;&#10;  env_vars=()&#10;&#10;  add_env_var &quot;ENV&quot; &quot;${ENV:-paper}&quot;&#10;  add_env_var &quot;DRY_RUN&quot; &quot;${DRY_RUN:-false}&quot;&#10;  add_env_var &quot;SYMBOL&quot; &quot;${SYMBOL:-ETHUSDT}&quot;&#10;  add_env_var &quot;LOG_LEVEL&quot; &quot;${LOG_LEVEL:-INFO}&quot;&#10;  add_env_var &quot;WS_ENABLE&quot; &quot;${WS_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_USER_ENABLE&quot; &quot;${WS_USER_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_PRICE_ENABLE&quot; &quot;${WS_PRICE_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_TRACE&quot; &quot;${WS_TRACE:-false}&quot;&#10;  add_env_var &quot;LOOP_ENABLE&quot; &quot;${LOOP_ENABLE:-true}&quot;&#10;  add_env_var &quot;LOOP_TRIGGER&quot; &quot;${LOOP_TRIGGER:-event}&quot;&#10;  add_env_var &quot;LOOP_INTERVAL_SEC&quot; &quot;${LOOP_INTERVAL_SEC:-60}&quot;&#10;  add_env_var &quot;LOOP_COOLDOWN_SEC&quot; &quot;${LOOP_COOLDOWN_SEC:-8}&quot;&#10;  add_env_var &quot;LOOP_BACKOFF_MAX_SEC&quot; &quot;${LOOP_BACKOFF_MAX_SEC:-30}&quot;&#10;  add_env_var &quot;MP_WINDOW_SEC&quot; &quot;${MP_WINDOW_SEC:-10}&quot;&#10;  add_env_var &quot;MP_DELTA_PCT&quot; &quot;${MP_DELTA_PCT:-0.35}&quot;&#10;  add_env_var &quot;KLINE_RANGE_PCT&quot; &quot;${KLINE_RANGE_PCT:-0.6}&quot;&#10;  add_env_var &quot;VOL_LOOKBACK&quot; &quot;${VOL_LOOKBACK:-20}&quot;&#10;  add_env_var &quot;VOL_MULT&quot; &quot;${VOL_MULT:-3.0}&quot;&#10;  add_env_var &quot;USE_QUOTE_VOLUME&quot; &quot;${USE_QUOTE_VOLUME:-true}&quot;&#10;  add_env_var &quot;LEVERAGE&quot; &quot;${LEVERAGE:-5}&quot;&#10;  add_env_var &quot;TZ&quot; &quot;${TZ:-Asia/Seoul}&quot;&#10;  add_env_var &quot;PROJECT_ID&quot; &quot;${PROJECT_ID}&quot;&#10;  add_env_var &quot;GOOGLE_CLOUD_PROJECT&quot; &quot;${PROJECT_ID}&quot;&#10;&#10;  secret_keys_regex='^(BINANCE_TESTNET_API_KEY|BINANCE_TESTNET_SECRET_KEY|OPENAI_API_KEY)$'&#10;  if [[ &quot;$LOAD_ENV_FILE&quot; == &quot;true&quot; &amp;&amp; -f &quot;$ENV_FILE&quot; ]]; then&#10;    while IFS= read -r line || [[ -n &quot;$line&quot; ]]; do&#10;      line=&quot;${line#${line%%[![:space:]]*}}&quot;&#10;      line=&quot;${line%${line##*[![:space:]]}}&quot;&#10;      if [[ &quot;$line&quot; =~ ^([^#]*[^[:space:]])[[:space:]]+#.*$ ]]; then&#10;        line=&quot;${BASH_REMATCH[1]}&quot;&#10;      fi&#10;      [[ -z &quot;$line&quot; || &quot;${line:0:1}&quot; == &quot;#&quot; ]] &amp;&amp; continue&#10;      [[ &quot;$line&quot; == export* ]] &amp;&amp; line=&quot;${line#export }&quot;&#10;      key=&quot;${line%%=*}&quot;&#10;      value=&quot;${line#*=}&quot;&#10;      key=&quot;${key#${key%%[![:space:]]*}}&quot;&#10;      key=&quot;${key%${key##*[![:space:]]}}&quot;&#10;      [[ -z &quot;$key&quot; || &quot;$key&quot; =~ $secret_keys_regex ]] &amp;&amp; continue&#10;      add_env_var &quot;$key&quot; &quot;$value&quot;&#10;    done &lt; &quot;$ENV_FILE&quot;&#10;  fi&#10;&#10;  [[ -n &quot;$GCS_BUCKET&quot; ]] &amp;&amp; add_env_var &quot;GCS_BUCKET&quot; &quot;$GCS_BUCKET&quot;&#10;  [[ -n &quot;$GCS_PREFIX&quot; ]] &amp;&amp; add_env_var &quot;GCS_PREFIX&quot; &quot;$GCS_PREFIX&quot;&#10;  [[ -n &quot;${RESTORE_RUNTIME:-}&quot; ]] &amp;&amp; add_env_var &quot;RESTORE_RUNTIME&quot; &quot;$RESTORE_RUNTIME&quot;&#10;&#10;  env_vars_payload=&quot;&quot;&#10;  for kv in &quot;${env_vars[@]}&quot;; do&#10;    env_vars_payload+=&quot;${kv}|&quot;&#10;  done&#10;  env_vars_payload=&quot;${env_vars_payload%|}&quot;&#10;&#10;  deploy_args=(&#10;    --image &quot;$IMAGE&quot;&#10;    --region &quot;$REGION&quot;&#10;    --platform managed&#10;    --memory &quot;$MEMORY&quot;&#10;    --cpu &quot;$CPU&quot;&#10;    --max-instances &quot;$MAX_INSTANCES&quot;&#10;    --set-env-vars &quot;^|^${env_vars_payload}&quot;&#10;    --set-secrets BINANCE_TESTNET_API_KEY=binance-testnet-api-key:latest,BINANCE_TESTNET_SECRET_KEY=binance-testnet-secret-key:latest,OPENAI_API_KEY=openai-api-key:latest&#10;  )&#10;  if [[ &quot;${ALLOW_UNAUTH}&quot; == &quot;true&quot; ]]; then&#10;    deploy_args+=(--allow-unauthenticated)&#10;  else&#10;    deploy_args+=(--no-allow-unauthenticated)&#10;  fi&#10;&#10;  gcloud run deploy &quot;$SERVICE&quot; &quot;${deploy_args[@]}&quot;&#10;&#10;  echo &quot;[DONE] Deployment finished.&quot;&#10;}&#10;&#10;main &quot;$@&quot;&#10;" />
              <option name="updatedContent" value="#!/usr/bin/env bash&#10;# Helper to build &amp; deploy auto-futures to Cloud Run with env/secrets.&#10;set -euo pipefail&#10;&#10;REPO_ROOT=$(cd &quot;$(dirname &quot;$0&quot;)/..&quot; &amp;&amp; pwd)&#10;cd &quot;$REPO_ROOT&quot;&#10;&#10;ENV_FILE=${ENV_FILE:-.env}&#10;LOAD_ENV_FILE=${LOAD_ENV_FILE:-true}&#10;if [[ &quot;$LOAD_ENV_FILE&quot; == &quot;true&quot; &amp;&amp; -f &quot;$ENV_FILE&quot; ]]; then&#10;  echo &quot;[STEP] Loading environment variables from $ENV_FILE&quot;&#10;  set -a&#10;  # shellcheck disable=SC1090&#10;  source &quot;$ENV_FILE&quot;&#10;  set +a&#10;fi&#10;&#10;PROJECT_ID=${PROJECT_ID:?&quot;set PROJECT_ID environment variable (e.g., PROJECT_ID=my-project)&quot;}&#10;REGION=${REGION:-asia-northeast3}&#10;SERVICE=${SERVICE:-auto-futures}&#10;IMAGE_NAME=${IMAGE_NAME:-auto-futures}&#10;IMAGE=${IMAGE:-&quot;asia-northeast3-docker.pkg.dev/${PROJECT_ID}/auto-futures/${IMAGE_NAME}&quot;}&#10;BUILD_CONFIG=${BUILD_CONFIG:-cloudbuild.yaml}&#10;MEMORY=${MEMORY:-1Gi}&#10;CPU=${CPU:-1}&#10;MAX_INSTANCES=${MAX_INSTANCES:-1}&#10;ALLOW_UNAUTH=${ALLOW_UNAUTH:-true}&#10;BUILD_LOGGING=${BUILD_LOGGING:-cloud-logging-only}&#10;GRANT_SECRET_ROLES=${GRANT_SECRET_ROLES:-true}&#10;SECRET_ROLE=${SECRET_ROLE:-roles/secretmanager.admin}&#10;SUPPORTS_BUILD_LOGGING_FLAG=&quot;&quot;&#10;SYNC_RUNTIME=${SYNC_RUNTIME:-false}&#10;SYNC_MODE=${SYNC_MODE:-upload}&#10;GCS_BUCKET=${GCS_BUCKET:-}&#10;GCS_PREFIX=${GCS_PREFIX:-runtime/}&#10;&#10;add_env_var() {&#10;  local key=&quot;$1&quot;&#10;  local value=&quot;$2&quot;&#10;  for i in &quot;${!env_vars[@]}&quot;; do&#10;    if [[ &quot;${env_vars[$i]%%=*}&quot; == &quot;$key&quot; ]]; then&#10;      env_vars[$i]=&quot;$key=$value&quot;&#10;      return&#10;    fi&#10;  done&#10;  env_vars+=(&quot;$key=$value&quot;)&#10;}&#10;&#10;ensure_secret() {&#10;  local secret=&quot;$1&quot;&#10;  if ! gcloud secrets describe &quot;$secret&quot; &gt;/dev/null 2&gt;&amp;1; then&#10;    echo &quot;[WARN] Secret $secret not found. Create it before deployment.&quot; &gt;&amp;2&#10;  fi&#10;}&#10;&#10;detect_build_logging_support() {&#10;  [[ -n &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; ]] &amp;&amp; return 0&#10;  if gcloud builds submit --help 2&gt;/dev/null | grep -q &quot;--logging&quot;; then&#10;    SUPPORTS_BUILD_LOGGING_FLAG=&quot;yes&quot;&#10;  else&#10;    SUPPORTS_BUILD_LOGGING_FLAG=&quot;no&quot;&#10;  fi&#10;}&#10;&#10;maybe_grant_secret_roles() {&#10;  [[ &quot;$GRANT_SECRET_ROLES&quot; == &quot;true&quot; ]] || return 0&#10;  local project_number&#10;  project_number=$(gcloud projects describe &quot;$PROJECT_ID&quot; --format='value(projectNumber)')&#10;  local build_sa=&quot;${project_number}@cloudbuild.gserviceaccount.com&quot;&#10;  local run_sa=&quot;${project_number}-compute@developer.gserviceaccount.com&quot;&#10;  echo &quot;[STEP] Ensuring Secret Manager role $SECRET_ROLE for $build_sa and $run_sa&quot;&#10;  gcloud projects add-iam-policy-binding &quot;$PROJECT_ID&quot; \&#10;    --member=&quot;serviceAccount:${build_sa}&quot; \&#10;    --role=&quot;$SECRET_ROLE&quot; &gt;/dev/null&#10;  gcloud projects add-iam-policy-binding &quot;$PROJECT_ID&quot; \&#10;    --member=&quot;serviceAccount:${run_sa}&quot; \&#10;    --role=&quot;$SECRET_ROLE&quot; &gt;/dev/null&#10;}&#10;&#10;sync_runtime() {&#10;  [[ &quot;$SYNC_RUNTIME&quot; == &quot;true&quot; ]] || return 0&#10;  if [[ -z &quot;$GCS_BUCKET&quot; ]]; then&#10;    echo &quot;[WARN] SYNC_RUNTIME=true지만 GCS_BUCKET이 설정되지 않았습니다. runtime 동기화를 건너뜁니다.&quot; &gt;&amp;2&#10;    return 0&#10;  fi&#10;  if ! command -v python3 &gt;/dev/null 2&gt;&amp;1; then&#10;    echo &quot;[WARN] python3를 찾을 수 없어 runtime 동기화를 건너뜁니다.&quot; &gt;&amp;2&#10;    return 0&#10;  fi&#10;  echo &quot;[STEP] Running runtime sync (${SYNC_MODE}) with bucket ${GCS_BUCKET}&quot;&#10;  if [[ &quot;$SYNC_MODE&quot; == &quot;upload&quot; ]]; then&#10;    python3 scripts/gcs_sync.py --bucket &quot;$GCS_BUCKET&quot; &quot;$SYNC_MODE&quot; --dest-prefix &quot;$GCS_PREFIX&quot; || echo &quot;[WARN] runtime 동기화 실패 (무시하고 계속 진행)&quot; &gt;&amp;2&#10;  else&#10;    python3 scripts/gcs_sync.py --bucket &quot;$GCS_BUCKET&quot; &quot;$SYNC_MODE&quot; --prefix &quot;$GCS_PREFIX&quot; || echo &quot;[WARN] runtime 동기화 실패 (무시하고 계속 진행)&quot; &gt;&amp;2&#10;  fi&#10;}&#10;&#10;main() {&#10;  gcloud config set project &quot;$PROJECT_ID&quot; &gt;/dev/null&#10;&#10;  sync_runtime&#10;&#10;  maybe_grant_secret_roles&#10;&#10;  echo &quot;[STEP] Building container image ${IMAGE}&quot;&#10;  detect_build_logging_support&#10;  if [[ -f &quot;$BUILD_CONFIG&quot; ]]; then&#10;    if [[ &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; == &quot;yes&quot; ]]; then&#10;      gcloud builds submit --config &quot;$BUILD_CONFIG&quot; --substitutions=_IMAGE=&quot;$IMAGE&quot; --logging=&quot;$BUILD_LOGGING&quot;&#10;    else&#10;      echo &quot;[INFO] gcloud builds submit --logging not supported on this version; using default logging behavior&quot;&#10;      gcloud builds submit --config &quot;$BUILD_CONFIG&quot; --substitutions=_IMAGE=&quot;$IMAGE&quot;&#10;    fi&#10;  else&#10;    if [[ &quot;$SUPPORTS_BUILD_LOGGING_FLAG&quot; == &quot;yes&quot; ]]; then&#10;      gcloud builds submit --tag &quot;$IMAGE&quot; --logging=&quot;$BUILD_LOGGING&quot;&#10;    else&#10;      echo &quot;[INFO] gcloud builds submit --logging not supported on this version; using default logging behavior&quot;&#10;      gcloud builds submit --tag &quot;$IMAGE&quot;&#10;    fi&#10;  fi&#10;&#10;  ensure_secret binance-testnet-api-key&#10;  ensure_secret binance-testnet-secret-key&#10;  ensure_secret openai-api-key&#10;&#10;  echo &quot;[STEP] Deploying ${SERVICE} to Cloud Run&quot;&#10;  env_vars=()&#10;&#10;  add_env_var &quot;ENV&quot; &quot;${ENV:-paper}&quot;&#10;  add_env_var &quot;DRY_RUN&quot; &quot;${DRY_RUN:-false}&quot;&#10;  add_env_var &quot;SYMBOL&quot; &quot;${SYMBOL:-ETHUSDT}&quot;&#10;  add_env_var &quot;LOG_LEVEL&quot; &quot;${LOG_LEVEL:-INFO}&quot;&#10;  add_env_var &quot;WS_ENABLE&quot; &quot;${WS_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_USER_ENABLE&quot; &quot;${WS_USER_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_PRICE_ENABLE&quot; &quot;${WS_PRICE_ENABLE:-true}&quot;&#10;  add_env_var &quot;WS_TRACE&quot; &quot;${WS_TRACE:-false}&quot;&#10;  add_env_var &quot;LOOP_ENABLE&quot; &quot;${LOOP_ENABLE:-true}&quot;&#10;  add_env_var &quot;LOOP_TRIGGER&quot; &quot;${LOOP_TRIGGER:-event}&quot;&#10;  add_env_var &quot;LOOP_INTERVAL_SEC&quot; &quot;${LOOP_INTERVAL_SEC:-60}&quot;&#10;  add_env_var &quot;LOOP_COOLDOWN_SEC&quot; &quot;${LOOP_COOLDOWN_SEC:-8}&quot;&#10;  add_env_var &quot;LOOP_BACKOFF_MAX_SEC&quot; &quot;${LOOP_BACKOFF_MAX_SEC:-30}&quot;&#10;  add_env_var &quot;MP_WINDOW_SEC&quot; &quot;${MP_WINDOW_SEC:-10}&quot;&#10;  add_env_var &quot;MP_DELTA_PCT&quot; &quot;${MP_DELTA_PCT:-0.35}&quot;&#10;  add_env_var &quot;KLINE_RANGE_PCT&quot; &quot;${KLINE_RANGE_PCT:-0.6}&quot;&#10;  add_env_var &quot;VOL_LOOKBACK&quot; &quot;${VOL_LOOKBACK:-20}&quot;&#10;  add_env_var &quot;VOL_MULT&quot; &quot;${VOL_MULT:-3.0}&quot;&#10;  add_env_var &quot;USE_QUOTE_VOLUME&quot; &quot;${USE_QUOTE_VOLUME:-true}&quot;&#10;  add_env_var &quot;LEVERAGE&quot; &quot;${LEVERAGE:-5}&quot;&#10;  add_env_var &quot;TZ&quot; &quot;${TZ:-Asia/Seoul}&quot;&#10;  add_env_var &quot;PROJECT_ID&quot; &quot;${PROJECT_ID}&quot;&#10;  add_env_var &quot;GOOGLE_CLOUD_PROJECT&quot; &quot;${PROJECT_ID}&quot;&#10;&#10;  secret_keys_regex='^(BINANCE_TESTNET_API_KEY|BINANCE_TESTNET_SECRET_KEY|OPENAI_API_KEY)$'&#10;  if [[ &quot;$LOAD_ENV_FILE&quot; == &quot;true&quot; &amp;&amp; -f &quot;$ENV_FILE&quot; ]]; then&#10;    while IFS= read -r line || [[ -n &quot;$line&quot; ]]; do&#10;      line=&quot;${line#${line%%[![:space:]]*}}&quot;&#10;      line=&quot;${line%${line##*[![:space:]]}}&quot;&#10;      if [[ &quot;$line&quot; =~ ^([^#]*[^[:space:]])[[:space:]]+#.*$ ]]; then&#10;        line=&quot;${BASH_REMATCH[1]}&quot;&#10;      fi&#10;      [[ -z &quot;$line&quot; || &quot;${line:0:1}&quot; == &quot;#&quot; ]] &amp;&amp; continue&#10;      [[ &quot;$line&quot; == export* ]] &amp;&amp; line=&quot;${line#export }&quot;&#10;      key=&quot;${line%%=*}&quot;&#10;      value=&quot;${line#*=}&quot;&#10;      key=&quot;${key#${key%%[![:space:]]*}}&quot;&#10;      key=&quot;${key%${key##*[![:space:]]}}&quot;&#10;      [[ -z &quot;$key&quot; || &quot;$key&quot; =~ $secret_keys_regex ]] &amp;&amp; continue&#10;      add_env_var &quot;$key&quot; &quot;$value&quot;&#10;    done &lt; &quot;$ENV_FILE&quot;&#10;  fi&#10;&#10;  [[ -n &quot;$GCS_BUCKET&quot; ]] &amp;&amp; add_env_var &quot;GCS_BUCKET&quot; &quot;$GCS_BUCKET&quot;&#10;  [[ -n &quot;$GCS_PREFIX&quot; ]] &amp;&amp; add_env_var &quot;GCS_PREFIX&quot; &quot;$GCS_PREFIX&quot;&#10;  [[ -n &quot;${RESTORE_RUNTIME:-}&quot; ]] &amp;&amp; add_env_var &quot;RESTORE_RUNTIME&quot; &quot;$RESTORE_RUNTIME&quot;&#10;&#10;  env_vars_payload=&quot;&quot;&#10;  for kv in &quot;${env_vars[@]}&quot;; do&#10;    env_vars_payload+=&quot;${kv}|&quot;&#10;  done&#10;  env_vars_payload=&quot;${env_vars_payload%|}&quot;&#10;&#10;  deploy_args=(&#10;    --image &quot;$IMAGE&quot;&#10;    --region &quot;$REGION&quot;&#10;    --platform managed&#10;    --memory &quot;$MEMORY&quot;&#10;    --cpu &quot;$CPU&quot;&#10;    --max-instances &quot;$MAX_INSTANCES&quot;&#10;    --set-env-vars &quot;^|^${env_vars_payload}&quot;&#10;    --set-secrets BINANCE_TESTNET_API_KEY=binance-testnet-api-key:latest,BINANCE_TESTNET_SECRET_KEY=binance-testnet-secret-key:latest,OPENAI_API_KEY=openai-api-key:latest&#10;  )&#10;  if [[ &quot;${ALLOW_UNAUTH}&quot; == &quot;true&quot; ]]; then&#10;    deploy_args+=(--allow-unauthenticated)&#10;  else&#10;    deploy_args+=(--no-allow-unauthenticated)&#10;  fi&#10;&#10;  gcloud run deploy &quot;$SERVICE&quot; &quot;${deploy_args[@]}&quot;&#10;&#10;  echo &quot;[DONE] Deployment finished.&quot;&#10;}&#10;&#10;main &quot;$@&quot;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>